<?xml version="1.0" encoding="UTF-8"?>
<!--
    ========================================================================
    SIFEN Paraguay - Sistema Integrado de Facturaci√≥n Electr√≥nica Nacional
    ========================================================================
    
    Schema: SiResultLoteDE_v150.xsd
    Versi√≥n: 1.50 (Septiembre 2019)
    
    Prop√≥sito:
    - Define la estructura para consultar resultados de lotes procesados
    - Permite obtener el estado final de cada documento en el lote
    - Usado despu√©s de recibir confirmaci√≥n de recepci√≥n exitosa (c√≥digo 0300)
    
    Namespace: http://ekuatia.set.gov.py/sifen/xsd
    Encoding: UTF-8
    
    Flujo de Uso:
    1. Enviar lote con SiRecepLoteDE_v150.xsd
    2. Recibir confirmaci√≥n con resRecepLoteDE_v150.xsd (c√≥digo 0300)
    3. Esperar procesamiento (3-15 minutos)
    4. Consultar resultados con este schema
    5. Obtener estados finales con resResultLoteDE_v150.xsd
    
    Timing Recomendado:
    - Primera consulta: 3 minutos despu√©s de recepci√≥n
    - Consultas subsequentes: cada 2 minutos
    - Timeout m√°ximo: 20 minutos
    - M√°ximo reintentos: 10 consultas
    
    Uso:
    - Web Service: /de/ws/consultas/consulta-lote.wsdl
    - M√©todo: SiResultLoteDE
    - Tipo: Request (Petici√≥n de consulta)
    
    ========================================================================
-->

<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    targetNamespace="http://ekuatia.set.gov.py/sifen/xsd"
    xmlns="http://ekuatia.set.gov.py/sifen/xsd"
    xmlns:tns="http://ekuatia.set.gov.py/sifen/xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"
    version="150">

    <!--
        ================================================================
        ELEMENTO RA√çZ - CONSULTA DE RESULTADOS DE LOTE
        ================================================================
    -->

    <xs:element name="rEnviConsLoteDe" type="tEnviConsLoteDe">
        <xs:annotation>
            <xs:documentation> Elemento ra√≠z para la consulta de resultados de lotes. Estructura: -
                dId: Identificador de control de la consulta - dProtAut: N√∫mero de protocolo del
                lote a consultar Prerequisitos: - Tener el n√∫mero de protocolo (dProtAut) del lote -
                El lote debe haber sido recibido exitosamente (c√≥digo 0300) - Esperar al menos 3
                minutos desde la recepci√≥n Estados esperables: - 0360: Lote en procesamiento (seguir
                consultando) - 0361: Procesamiento finalizado con errores parciales - 0362:
                Procesamiento finalizado exitosamente Uso t√≠pico: 1. Realizar primera consulta
                despu√©s de 3 minutos 2. Si estado = 0360, esperar 2 minutos y consultar nuevamente
                3. Si estado = 0361/0362, procesar resultados individuales 4. Implementar timeout de
                20 minutos m√°ximo </xs:documentation>
        </xs:annotation>
    </xs:element>

    <!--
        ================================================================
        TIPO PRINCIPAL - ESTRUCTURA DE LA CONSULTA
        ================================================================
    -->

    <xs:complexType name="tEnviConsLoteDe">
        <xs:annotation>
            <xs:documentation> Tipo principal que define la estructura de la consulta de resultados.
                Es deliberadamente simple para optimizar performance de consultas. </xs:documentation>
        </xs:annotation>

        <xs:sequence>
            <!-- ID de control de la consulta -->
            <xs:element name="dId" type="tIdConsulta">
                <xs:annotation>
                    <xs:documentation> Identificador √∫nico de control para la consulta. Prop√≥sito: -
                        Correlaci√≥n entre request y response de consulta - Trazabilidad de consultas
                        m√∫ltiples del mismo lote - Debugging y auditor√≠a de consultas - Control de
                        consultas duplicadas Caracter√≠sticas: - Entero positivo de 1 a 15 d√≠gitos -
                        Diferente del dId usado en el env√≠o original del lote - √önico por cada
                        consulta (no reutilizar) - Recomendable usar secuencia incremental
                        Estrategias de generaci√≥n: - Timestamp + secuencial: 20241220143501 - UUID
                        truncado: 123456789012345 - Contador simple: 1, 2, 3, 4... - Hash del
                        protocolo + timestamp Ejemplos v√°lidos: - 1 (consulta simple) - 123456789
                        (timestamp-based) - 20241220143001 (fecha + hora + secuencial) IMPORTANTE: -
                        No confundir con el dId del env√≠o original - Usar diferente ID para cada
                        intento de consulta - Guardar para correlaci√≥n con respuesta </xs:documentation>
                </xs:annotation>
            </xs:element>

            <!-- Protocolo del lote a consultar -->
            <xs:element name="dProtAut" type="tProtocoloLoteConsulta">
                <xs:annotation>
                    <xs:documentation> N√∫mero de protocolo del lote obtenido en la respuesta de
                        recepci√≥n. Origen: - Elemento dProtAut de resRecepLoteDE_v150.xsd - Solo
                        disponible cuando recepci√≥n fue exitosa (c√≥digo 0300) - Asignado
                        autom√°ticamente por SIFEN - Inmutable durante toda la vida del lote Formato:
                        LOT + 9 d√≠gitos Ejemplo: LOT123456789 Validaciones cr√≠ticas: ‚úÖ Debe
                        coincidir exactamente con el protocolo recibido ‚úÖ Formato LOT[0-9]{9}
                        estricto ‚úÖ No puede ser modificado o truncado ‚úÖ Case-sensitive (LOT en
                        may√∫sculas) Errores comunes: ‚ùå lot123456789 (min√∫sculas) ‚ùå LOT12345678 (8
                        d√≠gitos en lugar de 9) ‚ùå LOT1234567890 (10 d√≠gitos en lugar de 9) ‚ùå
                        LTE123456789 (prefijo incorrecto) ‚ùå LOT123456789 (espacios adicionales)
                        Estados del protocolo durante consulta: INICIAL (0-3 min): - Lote reci√©n
                        recibido, en cola de procesamiento - Consulta puede devolver "a√∫n no
                        iniciado" - Recomendaci√≥n: esperar 3 minutos antes de primera consulta
                        PROCESANDO (3-15 min): - SIFEN validando documentos individualmente - C√≥digo
                        0360: "Lote en procesamiento" - Acci√≥n: continuar consultando cada 2 minutos
                        FINALIZADO (15+ min): - C√≥digo 0361: "Procesamiento finalizado con errores"
                        - C√≥digo 0362: "Procesamiento finalizado exitosamente" - Acci√≥n: procesar
                        resultados individuales TIMEOUT (20+ min): - Si no hay respuesta final
                        despu√©s de 20 minutos - Posible problema en SIFEN o lote muy complejo -
                        Acci√≥n: contactar soporte t√©cnico SET Uso en aplicaciones: 1. Almacenar
                        protocolo al recibir confirmaci√≥n 2. Usar para todas las consultas del lote
                        3. Incluir en logs para trazabilidad 4. Referenciar en casos de soporte
                        t√©cnico 5. Mantener hasta obtener resultados finales </xs:documentation>
                </xs:annotation>
            </xs:element>
        </xs:sequence>
    </xs:complexType>

    <!--
        ================================================================
        TIPOS B√ÅSICOS Y RESTRICCIONES
        ================================================================
    -->

    <!-- Identificador de consulta -->
    <xs:simpleType name="tIdConsulta">
        <xs:annotation>
            <xs:documentation> Identificador √∫nico para cada consulta de resultados. Diferencias con
                otros IDs: - dId (env√≠o lote): ID del lote original - dId (consulta): ID de cada
                consulta individual - dProtAut: Protocolo asignado por SIFEN Buenas pr√°cticas: 1.
                Usar secuencia incremental simple: 1, 2, 3... 2. O incluir timestamp:
                20241220143001, 20241220143201... 3. No reutilizar el mismo ID en consultas
                simult√°neas 4. Correlacionar con logs para debugging Rango permitido: - M√≠nimo: 1 -
                M√°ximo: 999999999999999 (15 d√≠gitos) Consideraciones t√©cnicas: - Almacenar como
                entero largo (64-bit) - Validar rango antes de env√≠o - Usar para correlaci√≥n en
                respuestas as√≠ncronas - Incluir en logs de auditor√≠a Ejemplos de estrategias: SIMPLE
                (recomendado para pocas consultas): consulta_1: dId = 1 consulta_2: dId = 2
                consulta_3: dId = 3 TIMESTAMP (recomendado para alto volumen): consulta_1: dId =
                20241220143001 consulta_2: dId = 20241220143201 consulta_3: dId = 20241220143401
                HASH (para sistemas complejos): consulta_1: dId = hash(protocolo + timestamp) %
                999999999999999 </xs:documentation>
        </xs:annotation>

        <xs:restriction base="xs:long">
            <xs:minInclusive value="1">
                <xs:annotation>
                    <xs:documentation> Valor m√≠nimo: 1 No se permiten IDs negativos o cero. </xs:documentation>
                </xs:annotation>
            </xs:minInclusive>
            <xs:maxInclusive value="999999999999999">
                <xs:annotation>
                    <xs:documentation> Valor m√°ximo: 999999999999999 (15 d√≠gitos) L√≠mite t√©cnico
                        para compatibilidad con sistemas legacy. </xs:documentation>
                </xs:annotation>
            </xs:maxInclusive>
        </xs:restriction>
    </xs:simpleType>

    <!-- Protocolo de lote para consulta -->
    <xs:simpleType name="tProtocoloLoteConsulta">
        <xs:annotation>
            <xs:documentation> N√∫mero de protocolo del lote asignado por SIFEN. Debe coincidir
                exactamente con el recibido en resRecepLoteDE_v150.xsd. Validaci√≥n estricta del
                formato: - Prefijo: "LOT" (exactamente 3 caracteres, may√∫sculas) - Sufijo: 9 d√≠gitos
                num√©ricos consecutivos - Total: 12 caracteres exactos - Sin espacios, guiones o
                caracteres adicionales Algoritmo de validaci√≥n recomendado: 1. Verificar longitud =
                12 caracteres 2. Verificar primeros 3 caracteres = "LOT" 3. Verificar √∫ltimos 9
                caracteres son d√≠gitos 4. No permitir ceros consecutivos al inicio: LOT000000000
                Manejo de errores de formato: - Protocolo inv√°lido ‚Üí Error inmediato - Protocolo no
                encontrado ‚Üí Verificar si existe el lote - Protocolo expirado ‚Üí Verificar timestamps
                Casos de uso especiales: CONSULTA INMEDIATA (0-3 min despu√©s de env√≠o): - Puede
                devolver "lote no encontrado temporalmente" - Es normal, SIFEN puede tardar en
                indexar - Soluci√≥n: esperar 3 minutos y reintentar CONSULTA NORMAL (3-15 min despu√©s
                de env√≠o): - Debe devolver estado de procesamiento - 0360: A√∫n procesando -
                0361/0362: Procesamiento completado CONSULTA TARD√çA (15+ min despu√©s de env√≠o): -
                Mayor√≠a de lotes deben estar procesados - Si a√∫n en procesamiento, puede indicar
                problemas - Considerar escalaci√≥n a soporte t√©cnico CONSULTA MUY TARD√çA (24+ horas):
                - Resultados pueden haber sido archivados - Consultar pol√≠ticas de retenci√≥n de
                SIFEN - Usar otros medios para verificar estado Implementaci√≥n robusta: ```python
                def validar_protocolo_lote(protocolo): if not protocolo: raise ValueError("Protocolo
                no puede estar vac√≠o") if len(protocolo) != 12: raise ValueError(f"Protocolo debe
                tener 12 caracteres, tiene {len(protocolo)}") if not protocolo.startswith("LOT"):
                raise ValueError("Protocolo debe comenzar con 'LOT'") sufijo = protocolo[3:] if not
                sufijo.isdigit(): raise ValueError("√öltimos 9 caracteres deben ser d√≠gitos") if
                sufijo == "000000000": raise ValueError("Protocolo no puede ser todo ceros") return
                True ``` </xs:documentation>
        </xs:annotation>

        <xs:restriction base="xs:string">
            <xs:pattern value="LOT[0-9]{9}">
                <xs:annotation>
                    <xs:documentation> Patr√≥n exacto: LOT seguido de exactamente 9 d√≠gitos
                        num√©ricos. Componentes del patr√≥n: - LOT: Prefijo literal obligatorio
                        (case-sensitive) - [0-9]: Cualquier d√≠gito del 0 al 9 - {9}: Exactamente 9
                        repeticiones (no m√°s, no menos) Ejemplos que coinciden: ‚úÖ LOT123456789 ‚úÖ
                        LOT000000001 ‚úÖ LOT999999999 Ejemplos que NO coinciden: ‚ùå lot123456789
                        (min√∫sculas) ‚ùå LOT12345678 (8 d√≠gitos) ‚ùå LOT1234567890 (10 d√≠gitos) ‚ùå
                        LTE123456789 (prefijo incorrecto) ‚ùå LOT12345678A (car√°cter no num√©rico) ‚ùå
                        LOT 123456789 (espacio) Validaci√≥n adicional en aplicaci√≥n: - Verificar que
                        no sea protocolo de prueba - Verificar que corresponda al RUC del emisor -
                        Verificar que no est√© expirado - Mantener hist√≥rico para auditor√≠a </xs:documentation>
                </xs:annotation>
            </xs:pattern>
        </xs:restriction>
    </xs:simpleType>

    <!--
        ================================================================
        DOCUMENTACI√ìN ADICIONAL Y MEJORES PR√ÅCTICAS
        ================================================================
    -->

    <xs:annotation>
        <xs:documentation> ================================================================ EJEMPLOS
            COMPLETOS DE CONSULTAS ================================================================
            Ejemplo 1: Primera consulta (3 minutos despu√©s de env√≠o)
            -------------------------------------------------------- <rEnviConsLoteDe
                xmlns="http://ekuatia.set.gov.py/sifen/xsd">
                <dId>1</dId>
                <dProtAut>LOT123456789</dProtAut>
            </rEnviConsLoteDe> ‚û§ Uso: Primera
            verificaci√≥n del estado del lote ‚û§ Timing: 3 minutos despu√©s de recibir confirmaci√≥n
            Ejemplo 2: Consulta de seguimiento (5 minutos despu√©s)
            ------------------------------------------------------ <rEnviConsLoteDe
                xmlns="http://ekuatia.set.gov.py/sifen/xsd">
                <dId>2</dId>
                <dProtAut>LOT123456789</dProtAut>
            </rEnviConsLoteDe> ‚û§ Uso: Verificaci√≥n
            si a√∫n est√° procesando ‚û§ Timing: 2 minutos despu√©s de la primera consulta Ejemplo 3:
            Consulta con ID timestamp ------------------------------------ <rEnviConsLoteDe
                xmlns="http://ekuatia.set.gov.py/sifen/xsd">
                <dId>20241220143001</dId>
                <dProtAut>LOT987654321</dProtAut>
            </rEnviConsLoteDe> ‚û§ Uso: ID incluye
            fecha/hora para mejor trazabilidad ‚û§ Formato: YYYYMMDDHHMMSS + secuencial
            ================================================================ ESTRATEGIA DE CONSULTAS
            POLLING ================================================================ Algoritmo
            recomendado para consultas autom√°ticas: ```python import time from datetime import
            datetime, timedelta def consultar_resultados_lote(protocolo_lote, max_intentos=10): """
            Consulta resultados de lote con polling inteligente """ inicio = datetime.now() timeout
            = timedelta(minutes=20) for intento in range(1, max_intentos + 1): # Preparar consulta
            consulta = { "dId": intento, "dProtAut": protocolo_lote } print(f"üîç Consulta {intento}:
            {protocolo_lote}") # Enviar consulta respuesta = enviar_consulta_sifen(consulta) #
            Evaluar respuesta if respuesta.dCodResLot == "0362": print("‚úÖ Lote procesado
            exitosamente") return procesar_resultados_finales(respuesta) elif respuesta.dCodResLot
            == "0361": print("‚ö†Ô∏è Lote procesado con errores") return
            procesar_resultados_con_errores(respuesta) elif respuesta.dCodResLot == "0360": print("‚è≥
            Lote a√∫n en procesamiento...") # Verificar timeout if datetime.now() - inicio > timeout:
            print("‚è∞ Timeout: Lote tom√≥ m√°s de 20 minutos") break # Calcular delay inteligente if
            intento mayo= 3: delay = 120 # 2 minutos para primeras consultas elif intento mayo= 6:
            delay = 180 # 3 minutos para consultas medias else: delay = 300 # 5 minutos para
            consultas tard√≠as print(f"‚è∏Ô∏è Esperando {delay} segundos antes de siguiente consulta")
            time.sleep(delay) else: print(f"‚ùå Error inesperado: {respuesta.dCodResLot}") break # Si
            llegamos aqu√≠, algo sali√≥ mal raise TimeoutError(f"Lote {protocolo_lote} no se proces√≥
            en tiempo esperado") ```
            ================================================================ MANEJO DE ERRORES EN
            CONSULTAS ================================================================ Errores
            comunes y soluciones: ERROR: "Protocolo de lote no encontrado" ‚û§ Causa: Protocolo
            incorrecto o lote muy reciente ‚û§ Soluci√≥n: Verificar protocolo y esperar 3+ minutos
            ERROR: "Lote no existe" ‚û§ Causa: Protocolo inv√°lido o expirado ‚û§ Soluci√≥n: Verificar
            logs de env√≠o original ERROR: "Consulta muy frecuente" ‚û§ Causa: Consultas con menos de 1
            minuto de diferencia ‚û§ Soluci√≥n: Implementar rate limiting de consultas ERROR: "Servicio
            temporalmente no disponible" ‚û§ Causa: Mantenimiento o alta carga en SIFEN ‚û§ Soluci√≥n:
            Implementar backoff exponencial
            ================================================================ OPTIMIZACIONES DE
            PERFORMANCE ================================================================ 1. RATE
            LIMITING: - M√°ximo 1 consulta por minuto por protocolo - Usar queue para consultas
            m√∫ltiples - Implementar circuit breaker para errores 2. CACHING INTELIGENTE: - Cachear
            resultados finales (0361/0362) - No cachear estados intermedios (0360) - TTL de cache:
            24 horas para resultados finales 3. BATCH CONSULTAS: - Agrupar consultas de m√∫ltiples
            lotes - Usar threading para consultas paralelas - Respetar l√≠mites de rate limiting 4.
            MONITOREO: - Medir tiempo de respuesta de consultas - Alertar si lotes tardan > 15
            minutos - Estad√≠sticas de distribuci√≥n de tiempos
            ================================================================ INTEGRACI√ìN CON
            SISTEMAS DE AUDITOR√çA ================================================================
            Informaci√≥n para auditor√≠a de consultas: LOGS DE CONSULTA: - Timestamp de cada consulta
            - Protocolo consultado - ID de consulta usado - C√≥digo de respuesta obtenido - Tiempo de
            respuesta - N√∫mero de intento M√âTRICAS DE NEGOCIO: - Tiempo promedio de procesamiento
            por lote - Distribuci√≥n de estados finales (√©xito vs error) - Frecuencia de consultas
            por lote - Identificaci√≥n de lotes problem√°ticos ALERTAS OPERACIONALES: - Lotes que
            tardan > 20 minutos - Tasa de error en consultas > 5% - Protocolos que devuelven "no
            encontrado" - Servicios de consulta no disponibles REPORTES EJECUTIVOS: - Tiempo
            promedio de procesamiento por d√≠a/semana - Tasa de √©xito de lotes por per√≠odo -
            Identificaci√≥n de patrones de errores - Comparaci√≥n de performance vs SLA de SET </xs:documentation>
    </xs:annotation>

</xs:schema>