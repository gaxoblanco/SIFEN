<?xml version="1.0" encoding="UTF-8"?>
<!--
  Schema SIFEN v150 - Web Service Env√≠o Individual de Documentos
  Archivo: WS_SiRecepDE_v150.xsd
  Ubicaci√≥n: schemas/v150/official_set/webservices/individual/
  
  PROP√ìSITO:
  - Define la estructura completa del web service SiRecepDE
  - Orquesta la interacci√≥n request-response del env√≠o individual
  - Especifica los tipos de datos para la comunicaci√≥n SOAP
  - Valida la estructura completa del servicio web
  
  ARQUITECTURA DEL WEB SERVICE:
  1. Operaci√≥n: SiRecepDE (env√≠o individual)
  2. Input: siRecepDE (request con documento firmado)
  3. Output: resRecepDE (response con resultado)
  4. Protocol: SOAP 1.2 sobre HTTPS/TLS 1.2
  5. Authentication: Mutual TLS con certificados PSC
  
  ENDPOINTS OFICIALES:
  - Producci√≥n: https://sifen.set.gov.py/de/ws/sync/recibe.wsdl
  - Test: https://sifen-test.set.gov.py/de/ws/sync/recibe.wsdl
  
  FLUJO COMPLETO:
  1. Cliente prepara documento DE firmado
  2. Cliente crea request siRecepDE con documento
  3. Cliente invoca operaci√≥n SiRecepDE v√≠a SOAP
  4. SIFEN valida, procesa y firma digitalmente
  5. SIFEN retorna response resRecepDE con resultado
  6. Cliente procesa respuesta y actualiza estado
  
  COMPATIBILIDAD:
  ‚úÖ SIFEN v150 oficial SET Paraguay
  ‚úÖ SOAP 1.2 / WSDL 2.0
  ‚úÖ TLS 1.2 con autenticaci√≥n mutua
  ‚úÖ Certificados PSC Paraguay
  ‚úÖ XML Schema 1.0 est√°ndar
  
  Autor: Sistema SIFEN Paraguay
  Versi√≥n: 1.5.0
  Fecha: 2025-06-23
  Estado: Implementaci√≥n oficial SET
-->

<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://ekuatia.set.gov.py/sifen/xsd"
    xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
    xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
    targetNamespace="http://ekuatia.set.gov.py/sifen/xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"
    version="1.5.0">

    <!-- ===================================================================== -->
    <!-- IMPORTACIONES DE SCHEMAS DEPENDIENTES                                -->
    <!-- ===================================================================== -->

    <!-- Request y Response del env√≠o individual -->
    <xs:include schemaLocation="siRecepDE_v150.xsd" />
    <xs:include schemaLocation="resRecepDE_v150.xsd" />

    <!-- Tipos b√°sicos del sistema -->
    <xs:include schemaLocation="../../../modular/common/basic_types.xsd" />

    <!-- ===================================================================== -->
    <!-- TIPOS ESPEC√çFICOS PARA WEB SERVICE                                   -->
    <!-- ===================================================================== -->

    <!-- Tipo para identificaci√≥n del servicio -->
    <xs:simpleType name="tipoIdentificadorServicio">
        <xs:annotation>
            <xs:documentation> Identificador √∫nico del servicio web SIFEN VALORES V√ÅLIDOS: -
                "SiRecepDE": Servicio de env√≠o individual - Version: "1.5.0" PROP√ìSITO: -
                Identificaci√≥n un√≠voca del servicio - Versionado para compatibilidad - Routing
                interno en SIFEN - Logs y auditor√≠a </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:enumeration value="SiRecepDE">
                <xs:annotation>
                    <xs:documentation>Servicio de Recepci√≥n de Documentos Electr√≥nicos Individual</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
        </xs:restriction>
    </xs:simpleType>

    <!-- Tipo para versi√≥n del protocolo -->
    <xs:simpleType name="tipoVersionProtocolo">
        <xs:annotation>
            <xs:documentation> Versi√≥n del protocolo de comunicaci√≥n utilizado VERSI√ìN ACTUAL:
                "1.5.0" COMPATIBILIDAD: Backward compatible con versiones menores EVOLUCI√ìN: -
                v1.0.0: Implementaci√≥n inicial - v1.2.0: Mejoras en validaciones - v1.5.0: Versi√≥n
                actual con todas las caracter√≠sticas </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:enumeration value="1.5.0" />
        </xs:restriction>
    </xs:simpleType>

    <!-- ===================================================================== -->
    <!-- DEFINICI√ìN DE OPERACIONES DEL WEB SERVICE                            -->
    <!-- ===================================================================== -->

    <!-- Operaci√≥n principal: SiRecepDE -->
    <xs:element name="SiRecepDE">
        <xs:annotation>
            <xs:documentation> Operaci√≥n principal del web service para env√≠o individual de
                documentos FUNCIONALIDAD: - Recibe documento electr√≥nico firmado digitalmente -
                Valida estructura, contenido y firma digital - Procesa y registra en sistema SIFEN -
                Retorna resultado del procesamiento CARACTER√çSTICAS: - Procesamiento s√≠ncrono
                (respuesta inmediata) - Timeout m√°ximo: 60 segundos - Un documento por invocaci√≥n -
                Validaci√≥n completa en tiempo real PAR√ÅMETROS DE ENTRADA: - dId: Identificador √∫nico
                de control - xDe: Documento electr√≥nico firmado (XML completo) RESULTADO: - C√≥digo
                de resultado (√©xito/error) - Mensaje descriptivo - N√∫mero de autorizaci√≥n (si
                aprobado) - Fecha/hora de procesamiento CASOS DE USO: ‚úÖ Facturas urgentes que
                necesitan aprobaci√≥n inmediata ‚úÖ Documentos individuales con validaci√≥n en tiempo
                real ‚úÖ Integraci√≥n con sistemas POS/ERP en l√≠nea ‚ùå Env√≠o masivo de documentos (usar
                servicio de lotes) </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Request de env√≠o individual -->
                <xs:element ref="rEnviDe">
                    <xs:annotation>
                        <xs:documentation> Request de env√≠o individual que contiene: - dId: ID de
                            control √∫nico - xDe: Documento electr√≥nico firmado completo VALIDACIONES
                            AUTOM√ÅTICAS: - Estructura XML bien formada - Namespace SIFEN correcto -
                            Documento firmado digitalmente - Certificado PSC v√°lido y vigente -
                            Todos los campos obligatorios presentes </xs:documentation>
                    </xs:annotation>
                </xs:element>
            </xs:sequence>

            <!-- Atributos de la operaci√≥n -->
            <xs:attribute name="servicio" type="tipoIdentificadorServicio" fixed="SiRecepDE">
                <xs:annotation>
                    <xs:documentation>Identificador del servicio web invocado</xs:documentation>
                </xs:annotation>
            </xs:attribute>

            <xs:attribute name="version" type="tipoVersionProtocolo" fixed="1.5.0">
                <xs:annotation>
                    <xs:documentation>Versi√≥n del protocolo de comunicaci√≥n</xs:documentation>
                </xs:annotation>
            </xs:attribute>

        </xs:complexType>
    </xs:element>

    <!-- Respuesta de la operaci√≥n SiRecepDE -->
    <xs:element name="SiRecepDEResponse">
        <xs:annotation>
            <xs:documentation> Respuesta de la operaci√≥n SiRecepDE CONTENIDO: - Resultado del
                procesamiento del documento - Informaci√≥n de autorizaci√≥n o error - Metadatos del
                procesamiento ESTRUCTURA: - dId: Mismo ID del request (correlaci√≥n) - dCodRes:
                C√≥digo de resultado oficial - dMsgRes: Mensaje descriptivo - dFecProc: Timestamp del
                procesamiento - dProtAut: N√∫mero de autorizaci√≥n (si exitoso) INTERPRETACI√ìN POR
                C√ìDIGO: ‚úÖ 0260: Documento aprobado y registrado üü° 1005: Aprobado con observaciones
                menores ‚ùå 04xx: Error de validaci√≥n - corregir y reenviar ‚ùå 05xx: Error de firma -
                verificar certificado ‚ö†Ô∏è 99xx: Error t√©cnico - reintentar m√°s tarde </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Response del procesamiento -->
                <xs:element ref="resRecepDE">
                    <xs:annotation>
                        <xs:documentation> Response completo del procesamiento que incluye: - C√≥digo
                            y mensaje de resultado - Fecha/hora de procesamiento - N√∫mero de
                            autorizaci√≥n (si aprobado) - Informaci√≥n adicional relevante </xs:documentation>
                    </xs:annotation>
                </xs:element>
            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- TIPOS PARA MANEJO DE ERRORES Y EXCEPCIONES                          -->
    <!-- ===================================================================== -->

    <!-- Fault/Error del web service -->
    <xs:element name="SifenFault">
        <xs:annotation>
            <xs:documentation> Definici√≥n de errores/faults del web service SIFEN CATEGOR√çAS DE
                ERRORES: 1. Errores de protocolo SOAP 2. Errores de autenticaci√≥n/autorizaci√≥n 3.
                Errores de validaci√≥n de entrada 4. Errores internos del servidor 5. Errores de
                timeout o conectividad MANEJO: - Los errores se retornan como SOAP Faults - C√≥digo y
                mensaje descriptivo incluidos - Informaci√≥n para debugging cuando sea posible -
                Orientaci√≥n para resoluci√≥n del problema </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- C√≥digo del error -->
                <xs:element name="faultCode" type="xs:string">
                    <xs:annotation>
                        <xs:documentation> C√≥digo espec√≠fico del error ocurrido C√ìDIGOS COMUNES: -
                            SOAP-ENV:Client - Error en el cliente - SOAP-ENV:Server - Error en el
                            servidor - AUTH:InvalidCertificate - Certificado inv√°lido -
                            SIFEN:ValidationError - Error de validaci√≥n - SIFEN:ProcessingError -
                            Error de procesamiento </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Mensaje del error -->
                <xs:element name="faultString" type="xs:string">
                    <xs:annotation>
                        <xs:documentation> Mensaje descriptivo del error en espa√±ol EJEMPLOS: -
                            "Certificado digital vencido o inv√°lido" - "Documento XML mal formado" -
                            "Timeout en comunicaci√≥n con servidor" - "Servicio temporalmente no
                            disponible" </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Detalles adicionales del error -->
                <xs:element name="faultDetail" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> Detalles t√©cnicos adicionales del error CONTENIDO: -
                            Stack trace (en ambiente de desarrollo) - Referencias a documentaci√≥n -
                            Sugerencias de resoluci√≥n - Informaci√≥n de contacto de soporte </xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>
                            <xs:any namespace="##any" processContents="lax" minOccurs="0"
                                maxOccurs="unbounded" />
                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- DEFINICI√ìN DE HEADERS SOAP REQUERIDOS                               -->
    <!-- ===================================================================== -->

    <!-- Header de autenticaci√≥n -->
    <xs:element name="SifenAuthentication">
        <xs:annotation>
            <xs:documentation> Header SOAP para autenticaci√≥n con SIFEN PROP√ìSITO: - Identificaci√≥n
                del sistema cliente - Validaci√≥n de certificados PSC - Control de acceso y
                autorizaci√≥n - Auditor√≠a de accesos IMPLEMENTACI√ìN: - Incluir en SOAP Header de cada
                request - Certificado client SSL para mutual TLS - Informaci√≥n del sistema emisor
                SEGURIDAD: - TLS 1.2 obligatorio - Certificados PSC Paraguay v√°lidos - Validaci√≥n de
                cadena de certificaci√≥n - Control de revocaci√≥n (CRL/OCSP) </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Identificaci√≥n del sistema -->
                <xs:element name="sistemaEmisor" type="xs:string">
                    <xs:annotation>
                        <xs:documentation> Identificaci√≥n del sistema que env√≠a el documento
                            FORMATO: Nombre del sistema + versi√≥n EJEMPLO: "MiSistemaERP v2.1.5"
                            PROP√ìSITO: - Identificaci√≥n en logs SIFEN - Estad√≠sticas de uso por
                            sistema - Soporte t√©cnico especializado </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Versi√≥n del cliente -->
                <xs:element name="versionCliente" type="xs:string">
                    <xs:annotation>
                        <xs:documentation> Versi√≥n espec√≠fica del cliente SIFEN FORMATO: N√∫mero de
                            versi√≥n sem√°ntica EJEMPLO: "1.5.0" USO: - Compatibilidad de versiones -
                            Debugging de problemas - Notificaciones de actualizaciones </xs:documentation>
                    </xs:annotation>
                </xs:element>

            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- TIPOS AUXILIARES PARA INTEGRACI√ìN                                    -->
    <!-- ===================================================================== -->

    <!-- Tipo para configuraci√≥n del web service -->
    <xs:complexType name="tipoConfiguracionWS">
        <xs:annotation>
            <xs:documentation> Configuraci√≥n para integraci√≥n con el web service PAR√ÅMETROS DE
                CONFIGURACI√ìN: - URL del endpoint (producci√≥n/test) - Timeout de conexi√≥n -
                Certificados de autenticaci√≥n - Configuraci√≥n de retry - Configuraci√≥n de logging </xs:documentation>
        </xs:annotation>
        <xs:sequence>
            <xs:element name="endpointURL" type="xs:anyURI">
                <xs:annotation>
                    <xs:documentation> URL del endpoint del web service PRODUCCI√ìN:
                        https://sifen.set.gov.py/de/ws/sync/recibe.wsdl TEST:
                        https://sifen-test.set.gov.py/de/ws/sync/recibe.wsdl </xs:documentation>
                </xs:annotation>
            </xs:element>

            <xs:element name="timeoutSegundos" type="xs:int">
                <xs:annotation>
                    <xs:documentation> Timeout en segundos para la operaci√≥n RECOMENDADO: 60
                        segundos M√ÅXIMO: 120 segundos M√çNIMO: 30 segundos </xs:documentation>
                </xs:annotation>
            </xs:element>

            <xs:element name="reintentos" type="xs:int">
                <xs:annotation>
                    <xs:documentation> N√∫mero de reintentos autom√°ticos en caso de error t√©cnico
                        RECOMENDADO: 3 reintentos INTERVALO: Exponencial (1s, 2s, 4s) </xs:documentation>
                </xs:annotation>
            </xs:element>

        </xs:sequence>
    </xs:complexType>

    <!-- ===================================================================== -->
    <!-- VALIDACIONES DEL WEB SERVICE                                         -->
    <!-- ===================================================================== -->

    <!-- Elemento para testing del web service completo -->
    <xs:element name="testWebService">
        <xs:annotation>
            <xs:documentation> Elemento auxiliar para testing del web service completo PROP√ìSITO: -
                Validaci√≥n de estructura request-response - Testing de conectividad - Verificaci√≥n
                de configuraci√≥n - Debugging de integraci√≥n TESTS INCLUIDOS: - Estructura de
                operaci√≥n SiRecepDE - Validaci√≥n de headers SOAP - Verificaci√≥n de tipos de datos -
                Compatibilidad de versiones COMPATIBILIDAD: XSD 1.0 (oficial SET Paraguay) </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Test de operaci√≥n completa -->
                <xs:element name="operacionTest">
                    <xs:complexType>
                        <xs:sequence>
                            <xs:element ref="SiRecepDE" />
                            <xs:element ref="SiRecepDEResponse" />
                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- Test de configuraci√≥n -->
                <xs:element name="configuracionTest" type="tipoConfiguracionWS" />

            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- 
     ==== Operaci√≥n Principal: SiRecepDE ====
        <SiRecepDE servicio="SiRecepDE" version="1.5.0">
            <rEnviDe>
                <dId>1719158400</dId>
                <xDe> Documento DE firmado completo </xDe>
            </rEnviDe>
        </SiRecepDE>


     ====  Respuesta Estructurada ====
        <SiRecepDEResponse>
            <resRecepDE version="1.5.0">
                <dId>1719158400</dId>
                <dCodRes>0260</dCodRes>
                <dMsgRes>Documento recibido satisfactoriamente</dMsgRes>
                <dFecProc>2025-06-23T14:30:45</dFecProc>
                <dProtAut>12345678901234567890</dProtAut>
            </resRecepDE>
        </SiRecepDEResponse>   

     ==== Headers de Autenticaci√≥n ====
        <soap:Header>
            <SifenAuthentication>
                <sistemaEmisor>MiSistemaERP v2.1.5</sistemaEmisor>
                <versionCliente>1.5.0</versionCliente>
            </SifenAuthentication>
        </soap:Header>


     ==== Manejo de Errores SOAP ====
        <soap:Fault>
            <SifenFault>
                <faultCode>SIFEN:ValidationError</faultCode>
                <faultString>Error en validaci√≥n de documento</faultString>
                <faultDetail> Detalles espec√≠ficos </faultDetail>
            </SifenFault>
        </soap:Fault>

     ====  Implementaci√≥n en C√≥digo Python ==== 
        from zeep import Client
        from requests import Session
        from requests.auth import HTTPBasicAuth
        import ssl

        class SifenWebServiceClient:
            """Cliente para el Web Service SiRecepDE de SIFEN"""
            
            def __init__(self, ambiente="test", cert_path=None, cert_password=None):
                self.ambiente = ambiente
                self.wsdl_url = self._get_wsdl_url()
                self.client = self._create_client(cert_path, cert_password)
            
            def _get_wsdl_url(self):
                """Obtiene URL del WSDL seg√∫n ambiente"""
                if self.ambiente == "production":
                    return "https://sifen.set.gov.py/de/ws/sync/recibe.wsdl"
                else:
                    return "https://sifen-test.set.gov.py/de/ws/sync/recibe.wsdl"
            
            def _create_client(self, cert_path, cert_password):
                """Crea cliente SOAP con autenticaci√≥n mutual TLS"""
                session = Session()
                
                # Configurar certificado client para mutual TLS
                if cert_path:
                    session.cert = (cert_path, cert_password)
                
                # Configurar TLS 1.2
                session.verify = True
                
                return Client(
                    wsdl=self.wsdl_url,
                    transport=Transport(session=session),
                    settings=Settings(strict=False, xml_huge_tree=True)
                )
            
            def enviar_documento(self, xml_de_firmado: str, id_control: int = None):
                """Env√≠a documento electr√≥nico v√≠a SiRecepDE"""
                
                if id_control is None:
                    id_control = int(datetime.now().timestamp())
                
                # Preparar request seg√∫n schema WS_SiRecepDE_v150.xsd
                request_data = {
                    'rEnviDe': {
                        'dId': id_control,
                        'xDe': xml_de_firmado
                    }
                }
                
                # Headers de autenticaci√≥n
                headers = {
                    'SifenAuthentication': {
                        'sistemaEmisor': 'MiSistemaERP v2.1.5',
                        'versionCliente': '1.5.0'
                    }
                }
                
                try:
                    # Invocar operaci√≥n SiRecepDE
                    response = self.client.service.SiRecepDE(
                        **request_data,
                        _soapheaders=headers
                    )
                    
                    return self._procesar_respuesta(response)
                    
                except Exception as e:
                    return self._procesar_error(e)
            
            def _procesar_respuesta(self, response):
                """Procesa respuesta seg√∫n schema resRecepDE_v150.xsd"""
                return {
                    'success': response.dCodRes in ['0260', '1005'],
                    'codigo': response.dCodRes,
                    'mensaje': response.dMsgRes,
                    'fecha_procesamiento': response.dFecProc,
                    'numero_autorizacion': getattr(response, 'dProtAut', None),
                    'aprobado': response.dCodRes == '0260',
                    'con_observaciones': response.dCodRes == '1005'
                }
    -->
</xs:schema>