<?xml version="1.0" encoding="UTF-8"?>
<!--
  Schema SIFEN v150 - Protocolo de Procesamiento de Documentos Electr√≥nicos
  Archivo: protProcesDE_v150.xsd
  Ubicaci√≥n: schemas/v150/official_set/webservices/individual/
  
  PROP√ìSITO:
  - Define el protocolo completo de procesamiento de documentos en SIFEN
  - Especifica estados del documento durante su ciclo de vida
  - Estructura para seguimiento y auditor√≠a del procesamiento
  - Protocolo de comunicaci√≥n para consultas de estado
  
  CICLO DE VIDA DEL DOCUMENTO:
  1. RECIBIDO: Documento llega a SIFEN
  2. EN_VALIDACION: Validando estructura y firma
  3. APROBADO: Documento v√°lido y registrado
  4. RECHAZADO: Documento con errores, no registrado
  5. CANCELADO: Documento cancelado por evento posterior
  6. INUTILIZADO: Documento inutilizado por el emisor
  
  FUNCIONALIDADES:
  - Tracking completo del estado del documento
  - Historial de cambios de estado
  - Protocolo de consulta de estado
  - Informaci√≥n de procesamiento detallada
  - Metadatos para auditor√≠a y debugging
  
  INTEGRACI√ìN:
  - Complementa siRecepDE_v150.xsd (request)
  - Complementa resRecepDE_v150.xsd (response)
  - Base para consultas posteriores del estado
  - Fundamento para eventos (cancelaci√≥n, etc.)
  
  COMPATIBILIDAD:
  ‚úÖ SIFEN v150 oficial SET Paraguay
  ‚úÖ XML Schema 1.0 est√°ndar
  ‚úÖ Protocolo REST para consultas
  ‚úÖ Integraci√≥n con web services SIFEN
  
  Autor: Sistema SIFEN Paraguay
  Versi√≥n: 1.5.0
  Fecha: 2025-06-23
  Estado: Implementaci√≥n oficial SET
-->

<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://ekuatia.set.gov.py/sifen/xsd"
    targetNamespace="http://ekuatia.set.gov.py/sifen/xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"
    version="1.5.0">

    <!-- ===================================================================== -->
    <!-- IMPORTACIONES DE SCHEMAS DEPENDIENTES                                -->
    <!-- ===================================================================== -->

    <!-- Tipos b√°sicos del sistema -->
    <xs:include schemaLocation="../../../modular/common/basic_types.xsd" />

    <!-- Request y Response para referencia -->
    <xs:include schemaLocation="siRecepDE_v150.xsd" />
    <xs:include schemaLocation="resRecepDE_v150.xsd" />

    <!-- ===================================================================== -->
    <!-- ENUMERACIONES DE ESTADOS Y C√ìDIGOS                                   -->
    <!-- ===================================================================== -->

    <!-- Estados del documento en el protocolo -->
    <xs:simpleType name="tipoEstadoDocumento">
        <xs:annotation>
            <xs:documentation> Estados oficiales del documento durante su procesamiento en SIFEN
                FLUJO NORMAL: RECIBIDO ‚Üí EN_VALIDACION ‚Üí APROBADO FLUJO CON ERROR: RECIBIDO ‚Üí
                EN_VALIDACION ‚Üí RECHAZADO FLUJO CON EVENTOS POSTERIORES: APROBADO ‚Üí CANCELADO (por
                evento de cancelaci√≥n) APROBADO ‚Üí INUTILIZADO (por evento de inutilizaci√≥n)
                DESCRIPCI√ìN DE ESTADOS: üü° RECIBIDO: - Documento lleg√≥ a SIFEN correctamente - Est√°
                en cola de procesamiento - Validaciones b√°sicas superadas - Tiempo t√≠pico: 1-5
                segundos üü† EN_VALIDACION: - SIFEN est√° validando estructura y firma - Verificaci√≥n
                de certificados PSC - Validaciones de reglas de negocio - Tiempo t√≠pico: 5-30
                segundos ‚úÖ APROBADO: - Documento v√°lido y registrado oficialmente - CDC asignado y
                activo - Disponible para consultas p√∫blicas - Estado final positivo ‚ùå RECHAZADO: -
                Documento con errores no subsanables - No registrado en sistema SIFEN - Requiere
                correcci√≥n y reenv√≠o - Estado final negativo üö´ CANCELADO: - Documento previamente
                aprobado, ahora cancelado - Cancelaci√≥n por evento posterior del emisor - CDC
                mantiene registro hist√≥rico - No v√°lido para efectos tributarios ‚ö™ INUTILIZADO: -
                Documento inutilizado por el emisor - N√∫mero de documento "quemado" - No puede
                reutilizarse el n√∫mero - Registro de control interno </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:enumeration value="RECIBIDO">
                <xs:annotation>
                    <xs:documentation>Documento recibido correctamente en SIFEN</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
            <xs:enumeration value="EN_VALIDACION">
                <xs:annotation>
                    <xs:documentation>Documento en proceso de validaci√≥n</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
            <xs:enumeration value="APROBADO">
                <xs:annotation>
                    <xs:documentation>Documento aprobado y registrado</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
            <xs:enumeration value="RECHAZADO">
                <xs:annotation>
                    <xs:documentation>Documento rechazado por errores</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
            <xs:enumeration value="CANCELADO">
                <xs:annotation>
                    <xs:documentation>Documento cancelado por evento posterior</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
            <xs:enumeration value="INUTILIZADO">
                <xs:annotation>
                    <xs:documentation>Documento inutilizado por el emisor</xs:documentation>
                </xs:annotation>
            </xs:enumeration>
        </xs:restriction>
    </xs:simpleType>

    <!-- Tipos de procesamiento -->
    <xs:simpleType name="tipoProcesamiento">
        <xs:annotation>
            <xs:documentation> Tipos de procesamiento disponibles en SIFEN MODALIDADES: üì±
                INDIVIDUAL: - Un documento por request - Procesamiento s√≠ncrono - Respuesta
                inmediata - Ideal para: POS, sistemas en l√≠nea, facturas urgentes üì¶ LOTE: -
                M√∫ltiples documentos por request (hasta 50) - Procesamiento as√≠ncrono - Consulta
                posterior de resultados - Ideal para: sistemas ERP, facturaci√≥n masiva üîÑ REPUBLICA:
                - Reenv√≠o de documentos previamente procesados - Para correcci√≥n de errores t√©cnicos
                - Mantiene CDC original - Uso excepcional con autorizaci√≥n SET ‚ö° URGENTE: -
                Procesamiento prioritario - Para casos excepcionales - Requiere justificaci√≥n - Uso
                limitado por contribuyente </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:enumeration value="INDIVIDUAL" />
            <xs:enumeration value="LOTE" />
            <xs:enumeration value="REPUBLICA" />
            <xs:enumeration value="URGENTE" />
        </xs:restriction>
    </xs:simpleType>

    <!-- ===================================================================== -->
    <!-- ESTRUCTURA DEL PROTOCOLO DE PROCESAMIENTO                            -->
    <!-- ===================================================================== -->

    <!-- Elemento ra√≠z del protocolo -->
    <xs:element name="protProcesDE">
        <xs:annotation>
            <xs:documentation> Protocolo completo de procesamiento de documentos electr√≥nicos
                PROP√ìSITO: - Seguimiento completo del ciclo de vida del documento - Auditor√≠a
                detallada del procesamiento - Base para consultas de estado - Informaci√≥n para
                debugging y soporte INFORMACI√ìN INCLUIDA: - Identificaci√≥n del documento y request -
                Estado actual y historial de estados - Tiempos de procesamiento detallados -
                Informaci√≥n de validaciones realizadas - Metadatos t√©cnicos del procesamiento -
                Enlaces para consultas adicionales USOS: 1. Consulta de estado de documentos 2.
                Auditor√≠a de procesamiento 3. Debugging de problemas 4. Reportes de actividad 5.
                Integraci√≥n con sistemas de monitoreo </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>

                <!-- Identificaci√≥n del protocolo -->
                <xs:element name="gIdentificacion">
                    <xs:annotation>
                        <xs:documentation>Grupo de identificaci√≥n del protocolo</xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>

                            <!-- ID del protocolo (√∫nico por documento) -->
                            <xs:element name="dIdProtocolo" type="xs:string">
                                <xs:annotation>
                                    <xs:documentation> Identificador √∫nico del protocolo de
                                        procesamiento CARACTER√çSTICAS: - √önico por documento
                                        procesado - Generado autom√°ticamente por SIFEN - Formato:
                                        UUID o secuencial - Inmutable durante todo el ciclo de vida
                                        EJEMPLO: "PROT-2025-06-23-001234567" USO: - Referencia para
                                        consultas - Correlaci√≥n en logs - Soporte t√©cnico -
                                        Auditor√≠as oficiales </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- CDC del documento -->
                            <xs:element name="dCDC" type="tipoCDC">
                                <xs:annotation>
                                    <xs:documentation> C√≥digo de Control del Documento asociado
                                        RELACI√ìN: - Uno a uno con el documento original - Referencia
                                        principal para identificaci√≥n - Usado en consultas p√∫blicas
                                        - Clave para eventos posteriores FORMATO: 44 d√≠gitos
                                        num√©ricos EJEMPLO:
                                        "01234567890123456789012345678901234567890123" </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- ID de control del request -->
                            <xs:element name="dIdControl" type="xs:long">
                                <xs:annotation>
                                    <xs:documentation> ID de control del request original
                                        (correlaci√≥n) PROP√ìSITO: - Correlaciona con el ID enviado en
                                        rEnviDe/dId - Permite seguimiento request ‚Üí protocolo -
                                        Facilita debugging y logs - Referencia para el cliente
                                        EJEMPLO: 1719158400 </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- Tipo de procesamiento aplicado -->
                            <xs:element name="dTipoProceso" type="tipoProcesamiento">
                                <xs:annotation>
                                    <xs:documentation> Tipo de procesamiento que se aplic√≥ al
                                        documento VALORES: - INDIVIDUAL: Env√≠o individual est√°ndar -
                                        LOTE: Procesamiento en lote - REPUBLICA: Reenv√≠o por
                                        correcci√≥n - URGENTE: Procesamiento prioritario </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- Estado y seguimiento -->
                <xs:element name="gEstado">
                    <xs:annotation>
                        <xs:documentation>Grupo de informaci√≥n de estado del documento</xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>

                            <!-- Estado actual -->
                            <xs:element name="dEstadoActual" type="tipoEstadoDocumento">
                                <xs:annotation>
                                    <xs:documentation> Estado actual del documento en SIFEN
                                        INTERPRETACI√ìN: ‚úÖ APROBADO: Documento v√°lido y registrado ‚ùå
                                        RECHAZADO: Documento con errores üü° EN_VALIDACION:
                                        Procesando actualmente üü† RECIBIDO: En cola de procesamiento
                                        üö´ CANCELADO: Cancelado por evento ‚ö™ INUTILIZADO:
                                        Inutilizado por emisor ACCI√ìN POR ESTADO: - APROBADO:
                                        Documento listo para uso - RECHAZADO: Corregir y reenviar -
                                        EN_VALIDACION: Esperar resultado - RECIBIDO: Monitorear
                                        progreso - CANCELADO: Verificar evento de cancelaci√≥n -
                                        INUTILIZADO: Documento no utilizable </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- C√≥digo de resultado -->
                            <xs:element name="dCodigoResultado" type="tipoCodigoResultado">
                                <xs:annotation>
                                    <xs:documentation> C√≥digo espec√≠fico del resultado del
                                        procesamiento SINCRONIZACI√ìN: - Mismo valor que
                                        resRecepDE/dCodRes - Consistente en todo el protocolo - Base
                                        para l√≥gica de negocio EJEMPLOS: - 0260: Aprobado sin
                                        observaciones - 1005: Aprobado con observaciones - 0401:
                                        Error en estructura XML - 0501: Error en firma digital </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- Mensaje descriptivo -->
                            <xs:element name="dMensajeResultado" type="tipoMensajeResultado">
                                <xs:annotation>
                                    <xs:documentation> Mensaje descriptivo del estado/resultado
                                        actual CARACTER√çSTICAS: - Texto en espa√±ol - Informaci√≥n
                                        espec√≠fica y clara - Orientaci√≥n para el usuario -
                                        Actualizado con cada cambio de estado </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- Fecha del √∫ltimo cambio de estado -->
                            <xs:element name="dFechaUltimoCambio" type="tipoFechaProcesamiento">
                                <xs:annotation>
                                    <xs:documentation> Fecha y hora del √∫ltimo cambio de estado
                                        PROP√ìSITO: - Timestamp del √∫ltimo cambio - Base para
                                        c√°lculos de tiempo - Auditor√≠a de cambios - SLA y m√©tricas
                                        de performance FORMATO: YYYY-MM-DDTHH:mm:ss TIMEZONE: Hora
                                        local Paraguay (GMT-3) </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- Historial de procesamiento -->
                <xs:element name="gHistorial" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> Historial completo de cambios de estado CONTENIDO: -
                            Secuencia cronol√≥gica de todos los estados - Timestamps de cada
                            transici√≥n - Informaci√≥n adicional por estado - Trazabilidad completa
                            del procesamiento </xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>

                            <!-- Entrada del historial (repetible) -->
                            <xs:element name="dEntradaHistorial" maxOccurs="unbounded">
                                <xs:complexType>
                                    <xs:sequence>
                                        <!-- Secuencia de la entrada -->
                                        <xs:element name="dSecuencia" type="xs:int">
                                            <xs:annotation>
                                                <xs:documentation> N√∫mero secuencial de la entrada
                                                    en el historial ORDEN: 1. RECIBIDO 2.
                                                    EN_VALIDACION 3. APROBADO/RECHAZADO 4.
                                                    CANCELADO/INUTILIZADO (opcional) </xs:documentation>
                                            </xs:annotation>
                                        </xs:element>

                                        <!-- Estado registrado -->
                                        <xs:element name="dEstado" type="tipoEstadoDocumento">
                                            <xs:annotation>
                                                <xs:documentation>Estado registrado en esta entrada
                                                    del historial</xs:documentation>
                                            </xs:annotation>
                                        </xs:element>

                                        <!-- Fecha/hora del cambio -->
                                        <xs:element name="dFechaHora" type="tipoFechaProcesamiento">
                                            <xs:annotation>
                                                <xs:documentation>Timestamp exacto del cambio de
                                                    estado</xs:documentation>
                                            </xs:annotation>
                                        </xs:element>

                                        <!-- Informaci√≥n adicional -->
                                        <xs:element name="dObservaciones" type="xs:string"
                                            minOccurs="0">
                                            <xs:annotation>
                                                <xs:documentation> Observaciones adicionales sobre
                                                    este cambio de estado EJEMPLOS: - "Validaci√≥n
                                                    exitosa en 15.3 segundos" - "Error detectado en
                                                    campo E605" - "Cancelado por evento registrado" </xs:documentation>
                                            </xs:annotation>
                                        </xs:element>

                                    </xs:sequence>
                                </xs:complexType>
                            </xs:element>

                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- Informaci√≥n t√©cnica del procesamiento -->
                <xs:element name="gInfoTecnica" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation>Informaci√≥n t√©cnica detallada del procesamiento</xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>

                            <!-- Servidor que proces√≥ -->
                            <xs:element name="dServidorProceso" type="xs:string" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation> Identificaci√≥n del servidor SIFEN que proces√≥
                                        el documento FORMATO: "SIFEN-SRV-01" o similar USO:
                                        Debugging y balanceamiento de carga </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- Tiempo total de procesamiento -->
                            <xs:element name="dTiempoProceso" type="xs:decimal" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation> Tiempo total de procesamiento en segundos
                                        M√âTRICAS: - Tiempo desde recepci√≥n hasta estado final -
                                        Incluye todas las validaciones - Base para SLA y
                                        optimizaciones EJEMPLO: 23.456 (23.456 segundos) </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- Versi√≥n del motor de validaci√≥n -->
                            <xs:element name="dVersionValidador" type="xs:string" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation> Versi√≥n del motor de validaci√≥n utilizado
                                        FORMATO: "SIFEN-VALIDATOR-v1.5.0" USO: Compatibilidad y
                                        debugging </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- Enlaces y referencias -->
                <xs:element name="gReferencias" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation>Enlaces y referencias para consultas adicionales</xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>

                            <!-- URL de consulta p√∫blica -->
                            <xs:element name="dUrlConsultaPublica" type="xs:anyURI" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation> URL para consulta p√∫blica del documento (si
                                        est√° aprobado) FORMATO:
                                        https://ekuatia.set.gov.py/consultas/qr?nVersion=150&amp;Id=01234567890123456789012345678901234567890123&amp;...
                                        DISPONIBILIDAD: - Solo para documentos en estado APROBADO -
                                        Accesible sin autenticaci√≥n - Informaci√≥n b√°sica del
                                        documento </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                            <!-- URL de consulta detallada -->
                            <xs:element name="dUrlConsultaDetallada" type="xs:anyURI" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation> URL para consulta detallada (requiere
                                        autenticaci√≥n) ACCESO: - Requiere certificado PSC -
                                        Informaci√≥n completa del documento - Historial de eventos -
                                        Solo para emisor y receptor </xs:documentation>
                                </xs:annotation>
                            </xs:element>

                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

            </xs:sequence>

            <!-- Atributos del protocolo -->
            <xs:attribute name="version" type="xs:string" fixed="1.5.0">
                <xs:annotation>
                    <xs:documentation>Versi√≥n del protocolo de procesamiento</xs:documentation>
                </xs:annotation>
            </xs:attribute>

            <xs:attribute name="generado" type="tipoFechaProcesamiento">
                <xs:annotation>
                    <xs:documentation>Fecha y hora de generaci√≥n del protocolo</xs:documentation>
                </xs:annotation>
            </xs:attribute>

        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- ELEMENTOS AUXILIARES PARA CONSULTAS                                  -->
    <!-- ===================================================================== -->

    <!-- Request para consulta de protocolo -->
    <xs:element name="consultaProtocolo">
        <xs:annotation>
            <xs:documentation> Request para consultar el protocolo de procesamiento de un documento
                PAR√ÅMETROS: - CDC o ID de protocolo - Tipo de consulta (b√°sica/detallada) -
                Credenciales de autenticaci√≥n </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Identificador del documento -->
                <xs:choice>
                    <xs:element name="dCDC" type="tipoCDC">
                        <xs:annotation>
                            <xs:documentation>CDC del documento a consultar</xs:documentation>
                        </xs:annotation>
                    </xs:element>
                    <xs:element name="dIdProtocolo" type="xs:string">
                        <xs:annotation>
                            <xs:documentation>ID del protocolo a consultar</xs:documentation>
                        </xs:annotation>
                    </xs:element>
                </xs:choice>

                <!-- Tipo de consulta -->
                <xs:element name="dTipoConsulta">
                    <xs:simpleType>
                        <xs:restriction base="xs:string">
                            <xs:enumeration value="BASICA" />      <!-- Solo estado actual -->
                            <xs:enumeration value="DETALLADA" />   <!-- Historial completo -->
                            <xs:enumeration value="TECNICA" />     <!-- Info t√©cnica adicional -->
                        </xs:restriction>
                    </xs:simpleType>
                </xs:element>

            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- Response de consulta de protocolo -->
    <xs:element name="consultaProtocoloResponse">
        <xs:annotation>
            <xs:documentation>Response de consulta de protocolo</xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Resultado de la consulta -->
                <xs:element name="dResultado">
                    <xs:simpleType>
                        <xs:restriction base="xs:string">
                            <xs:enumeration value="ENCONTRADO" />
                            <xs:enumeration value="NO_ENCONTRADO" />
                            <xs:enumeration value="SIN_PERMISOS" />
                            <xs:enumeration value="ERROR" />
                        </xs:restriction>
                    </xs:simpleType>
                </xs:element>

                <!-- Protocolo (si encontrado) -->
                <xs:element ref="protProcesDE" minOccurs="0" />

                <!-- Mensaje de error (si aplica) -->
                <xs:element name="dMensajeError" type="xs:string" minOccurs="0" />

            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- VALIDACIONES DEL PROTOCOLO                                           -->
    <!-- ===================================================================== -->

    <!-- Elemento para testing del protocolo -->
    <xs:element name="testProtocolo">
        <xs:annotation>
            <xs:documentation> Elemento auxiliar para testing del protocolo completo PROP√ìSITO: -
                Validaci√≥n de estructura del protocolo - Testing de estados y transiciones -
                Verificaci√≥n de consistencia de datos - Debugging de problemas de protocolo
                COMPATIBILIDAD: XSD 1.0 (oficial SET Paraguay) </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <xs:element ref="protProcesDE" />
                <xs:element ref="consultaProtocolo" />
                <xs:element ref="consultaProtocoloResponse" />
            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!-- 
        ====  Estados del Documento ====
        <gEstado>
            <dEstadoActual>APROBADO</dEstadoActual>
            <dCodigoResultado>0260</dCodigoResultado>
            <dMensajeResultado>Documento recibido satisfactoriamente</dMensajeResultado>
            <dFechaUltimoCambio>2025-06-23T14:30:45</dFechaUltimoCambio>
        </gEstado>

        ====  Historial Completo ====
        <gHistorial>
            <dEntradaHistorial>
                <dSecuencia>1</dSecuencia>
                <dEstado>RECIBIDO</dEstado>
                <dFechaHora>2025-06-23T14:30:00</dFechaHora>
                <dObservaciones>Documento recibido correctamente</dObservaciones>
            </dEntradaHistorial>
            <dEntradaHistorial>
                <dSecuencia>2</dSecuencia>
                <dEstado>EN_VALIDACION</dEstado>
                <dFechaHora>2025-06-23T14:30:15</dFechaHora>
                <dObservaciones>Iniciando validaci√≥n estructural</dObservaciones>
            </dEntradaHistorial>
            <dEntradaHistorial>
                <dSecuencia>3</dSecuencia>
                <dEstado>APROBADO</dEstado>
                <dFechaHora>2025-06-23T14:30:45</dFechaHora>
                <dObservaciones>Validaci√≥n exitosa en 15.3 segundos</dObservaciones>
            </dEntradaHistorial>
        </gHistorial>

        ==== Implementaci√≥n Completa en Python ====
        def consultar_estado_documento(cdc: str) -> dict:
            """Consulta el estado actual de un documento en SIFEN"""
            
            request_data = {
                'consultaProtocolo': {
                    'dCDC': cdc,
                    'dTipoConsulta': 'DETALLADA'
                }
            }
            
            try:
                response = sifen_client.service.ConsultarProtocolo(**request_data)
                
                if response.dResultado == 'ENCONTRADO':
                    protocolo = response.protProcesDE
                    
                    return {
                        'encontrado': True,
                        'cdc': protocolo.gIdentificacion.dCDC,
                        'estado_actual': protocolo.gEstado.dEstadoActual,
                        'codigo_resultado': protocolo.gEstado.dCodigoResultado,
                        'mensaje': protocolo.gEstado.dMensajeResultado,
                        'fecha_ultimo_cambio': protocolo.gEstado.dFechaUltimoCambio,
                        'historial': [
                            {
                                'secuencia': entrada.dSecuencia,
                                'estado': entrada.dEstado,
                                'fecha_hora': entrada.dFechaHora,
                                'observaciones': entrada.dObservaciones
                            }
                            for entrada in protocolo.gHistorial.dEntradaHistorial
                        ],
                        'url_consulta_publica': getattr(protocolo.gReferencias, 'dUrlConsultaPublica', None)
                    }
                else:
                    return {
                        'encontrado': False,
                        'error': response.dMensajeError
                    }
                    
            except Exception as e:
                return {
                    'encontrado': False,
                    'error': f"Error en consulta: {str(e)}"
                }

        class SifenEnvioIndividualCompleto:
            """Cliente completo para env√≠o individual con seguimiento"""
            
            def __init__(self, ambiente="test", cert_path=None, cert_password=None):
                self.client = SifenWebServiceClient(ambiente, cert_path, cert_password)
            
            def enviar_documento_completo(self, xml_de_firmado: str) -> dict:
                """Env√≠o completo con seguimiento autom√°tico"""
                
                # 1. Enviar documento
                resultado_envio = self.client.enviar_documento(xml_de_firmado)
                
                if not resultado_envio['success']:
                    return {
                        'exito': False,
                        'fase': 'ENVIO',
                        'error': resultado_envio['mensaje'],
                        'codigo': resultado_envio['codigo']
                    }
                
                # 2. Si fue exitoso, consultar protocolo
                if resultado_envio['numero_autorizacion']:
                    # Extraer CDC del documento enviado
                    cdc = self._extraer_cdc(xml_de_firmado)
                    
                    # Consultar estado detallado
                    estado = consultar_estado_documento(cdc)
                    
                    return {
                        'exito': True,
                        'fase': 'COMPLETADO',
                        'envio': resultado_envio,
                        'protocolo': estado,
                        'recomendacion': self._generar_recomendacion(estado)
                    }
                
                return resultado_envio
            
            def _extraer_cdc(self, xml_documento: str) -> str:
                """Extrae CDC del documento XML"""
                try:
                    root = ET.fromstring(xml_documento)
                    # El CDC est√° en el atributo Id del elemento DE
                    de_element = root.find('.//{http://ekuatia.set.gov.py/sifen/xsd}DE')
                    return de_element.get('Id') if de_element is not None else None
                except:
                    return None
            
            def _generar_recomendacion(self, estado: dict) -> str:
                """Genera recomendaci√≥n basada en el estado"""
                if not estado['encontrado']:
                    return "Verificar CDC y reintentar consulta"
                
                estado_actual = estado['estado_actual']
                
                recomendaciones = {
                    'APROBADO': "‚úÖ Documento aprobado. Listo para uso comercial.",
                    'RECHAZADO': "‚ùå Corregir errores indicados y reenviar documento.",
                    'EN_VALIDACION': "üü° Documento proces√°ndose. Consultar en unos minutos.",
                    'RECIBIDO': "üü† Documento en cola. Monitorear progreso.",
                    'CANCELADO': "üö´ Documento cancelado. Verificar evento de cancelaci√≥n.",
                    'INUTILIZADO': "‚ö™ Documento inutilizado. No utilizable."
                }
                
                return recomendaciones.get(estado_actual, "Estado desconocido")
    
    -->
</xs:schema>