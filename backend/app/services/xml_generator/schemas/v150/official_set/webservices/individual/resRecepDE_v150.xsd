<?xml version="1.0" encoding="UTF-8"?>
<!--
  Schema SIFEN v150 - Response Env√≠o Individual de Documentos
  Archivo: resRecepDE_v150.xsd
  Ubicaci√≥n: schemas/v150/official_set/webservices/individual/
  
  PROP√ìSITO:
  - Define la estructura de respuesta del web service SiRecepDE
  - Valida el formato de respuesta enviado por SIFEN
  - Contiene resultado del procesamiento y validaci√≥n del documento
  
  FLUJO DE RESPUESTA:
  1. SIFEN recibe y valida documento
  2. SIFEN procesa y verifica firma digital
  3. SIFEN genera respuesta con este formato
  4. Cliente procesa respuesta y toma acciones
  
  TIPOS DE RESPUESTA:
  ‚úÖ Aprobado (0260) - Documento aceptado y registrado
  üü° Aprobado con observaci√≥n (1005) - Aceptado con warnings
  ‚ùå Rechazado (04xx, 05xx) - Errores de validaci√≥n
  ‚ö†Ô∏è Error t√©cnico (99xx) - Problemas sistema SIFEN
  
  COMPATIBILIDAD:
  ‚úÖ SIFEN v150 oficial SET Paraguay
  ‚úÖ Protocolo SOAP 1.2
  ‚úÖ Est√°ndar W3C XML Schema 1.0
  ‚úÖ Compatible con todos los procesadores XSD
  
  Autor: Sistema SIFEN Paraguay
  Versi√≥n: 1.5.0
  Fecha: 2025-06-23
  Estado: Implementaci√≥n oficial SET
-->

<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://ekuatia.set.gov.py/sifen/xsd"
    targetNamespace="http://ekuatia.set.gov.py/sifen/xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"
    version="1.5.0">

    <!-- ===================================================================== -->
    <!-- IMPORTACIONES Y DEPENDENCIAS                                         -->
    <!-- ===================================================================== -->

    <!-- Tipos b√°sicos del sistema modular -->
    <xs:include schemaLocation="../../../modular/common/basic_types.xsd" />

    <!-- ===================================================================== -->
    <!-- TIPOS ESPEC√çFICOS PARA C√ìDIGOS DE RESPUESTA SIFEN                    -->
    <!-- ===================================================================== -->

    <!-- C√≥digos de resultado oficiales SIFEN -->
    <xs:simpleType name="tipoCodigoResultado">
        <xs:annotation>
            <xs:documentation> C√≥digos de resultado oficiales del sistema SIFEN CATEGOR√çAS DE
                C√ìDIGOS: - 0260: Aprobado sin observaciones - 1005: Aprobado con observaciones
                menores - 04xx: Errores de validaci√≥n de documento - 05xx: Errores de firma digital
                o certificado - 99xx: Errores t√©cnicos del sistema SIFEN C√ìDIGOS M√ÅS COMUNES: ‚úÖ 0260
                - Documento aprobado exitosamente üü° 1005 - Aprobado con observaciones ‚ùå 0401 -
                Error en estructura XML ‚ùå 0402 - Error en datos obligatorios ‚ùå 0403 - Error en
                c√°lculos matem√°ticos ‚ùå 0501 - Error en firma digital ‚ùå 0502 - Certificado inv√°lido o
                vencido ‚ö†Ô∏è 9901 - Error interno del servidor ‚ö†Ô∏è 9902 - Servicio temporalmente no
                disponible REFERENCIA: Manual T√©cnico SIFEN v150, Anexo de C√≥digos </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <!-- C√≥digos de √©xito -->
            <xs:pattern value="0260|1005" />
            <!-- C√≥digos de error de validaci√≥n (04xx) -->
            <xs:pattern value="04[0-9][0-9]" />
            <!-- C√≥digos de error de firma/certificado (05xx) -->
            <xs:pattern value="05[0-9][0-9]" />
            <!-- C√≥digos de error t√©cnico (99xx) -->
            <xs:pattern value="99[0-9][0-9]" />
        </xs:restriction>
    </xs:simpleType>

    <!-- Mensajes de resultado descriptivos -->
    <xs:simpleType name="tipoMensajeResultado">
        <xs:annotation>
            <xs:documentation> Mensaje descriptivo del resultado del procesamiento EJEMPLOS T√çPICOS:
                - "Documento electr√≥nico recibido satisfactoriamente" - "Documento aprobado con
                observaciones menores" - "Error en validaci√≥n de estructura XML" - "Firma digital
                inv√°lida o certificado vencido" - "Error interno del servidor, reintente m√°s tarde"
                CARACTER√çSTICAS: - Texto en espa√±ol - Descripci√≥n clara del resultado - Orientaci√≥n
                para el desarrollador - M√°ximo 500 caracteres </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:minLength value="10" />
            <xs:maxLength value="500" />
            <xs:whiteSpace value="collapse" />
        </xs:restriction>
    </xs:simpleType>

    <!-- Tipo para fecha y hora de procesamiento -->
    <xs:simpleType name="tipoFechaProcesamiento">
        <xs:annotation>
            <xs:documentation> Fecha y hora exacta cuando SIFEN proces√≥ el documento FORMATO: ISO
                8601 - YYYY-MM-DDTHH:mm:ss TIMEZONE: Hora local Paraguay (GMT-3) EJEMPLOS: -
                2025-06-23T14:30:45 - 2025-12-15T09:15:30 IMPORTANCIA: - Timestamp oficial para
                auditor√≠a - Referencia para validez temporal - Ordenamiento cronol√≥gico </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:pattern value="\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}" />
            <xs:length value="19" />
        </xs:restriction>
    </xs:simpleType>

    <!-- N√∫mero de transacci√≥n o protocolo de autorizaci√≥n -->
    <xs:simpleType name="tipoNumeroTransaccion">
        <xs:annotation>
            <xs:documentation> N√∫mero de transacci√≥n o protocolo de autorizaci√≥n generado por SIFEN
                CARACTER√çSTICAS: - √önico por documento procesado - Generado autom√°ticamente por
                SIFEN - Utilizado para consultas posteriores - Requerido para eventos (cancelaci√≥n,
                etc.) FORMATO: - Num√©rico largo - Entre 10 y 20 d√≠gitos - Sin caracteres especiales
                EJEMPLO: 12345678901234567890 USO POSTERIOR: - Consulta estado documento - Registro
                de eventos - Soporte t√©cnico - Auditor√≠as </xs:documentation>
        </xs:annotation>
        <xs:restriction base="xs:string">
            <xs:pattern value="[0-9]{10,20}" />
            <xs:minLength value="10" />
            <xs:maxLength value="20" />
        </xs:restriction>
    </xs:simpleType>

    <!-- ===================================================================== -->
    <!-- ESTRUCTURA DE RESPUESTA PRINCIPAL                                    -->
    <!-- ===================================================================== -->

    <!-- Elemento ra√≠z de la respuesta -->
    <xs:element name="resRecepDE">
        <xs:annotation>
            <xs:documentation> Respuesta del sistema SIFEN para env√≠o individual de documentos
                ESTRUCTURA FUNCIONAL: - Informaci√≥n de control y identificaci√≥n - Resultado del
                procesamiento - Datos de autorizaci√≥n (si exitoso) - Informaci√≥n adicional y
                observaciones CASOS DE USO POR RESULTADO: ‚úÖ √âXITO (0260): - dCodRes = "0260" -
                dMsgRes = "Documento recibido satisfactoriamente" - dProtAut = n√∫mero de
                autorizaci√≥n - Documento queda aprobado y v√°lido üü° √âXITO CON OBSERVACIONES (1005):
                - dCodRes = "1005" - dMsgRes = descripci√≥n de observaciones - dProtAut = n√∫mero de
                autorizaci√≥n - Documento aprobado pero con warnings ‚ùå ERROR DE VALIDACI√ìN (04xx): -
                dCodRes = c√≥digo espec√≠fico de error - dMsgRes = descripci√≥n detallada del error -
                SIN dProtAut (no autorizado) - Documento rechazado, corregir y reenviar ‚ùå ERROR DE
                FIRMA (05xx): - dCodRes = c√≥digo de error de firma - dMsgRes = problema espec√≠fico
                con certificado - SIN dProtAut (no autorizado) - Verificar certificado y firma
                digital ‚ö†Ô∏è ERROR T√âCNICO (99xx): - dCodRes = c√≥digo de error t√©cnico - dMsgRes =
                descripci√≥n del problema t√©cnico - SIN dProtAut (no procesado) - Reintentar env√≠o
                m√°s tarde </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>

                <!-- ID de Control (correlaci√≥n con request) -->
                <xs:element name="dId" type="xs:long">
                    <xs:annotation>
                        <xs:documentation> Identificador de control que correlaciona con el request
                            enviado PROP√ìSITO: - Mismo valor que se envi√≥ en rEnviDe/dId - Permite
                            correlacionar request-response - Facilita debugging y logs VALIDACI√ìN: -
                            Debe coincidir exactamente con el ID del request - Valor positivo mayor
                            que 0 EJEMPLO: Request: rEnviDe/dId = 1719158400 Response:
                            resRecepDE/dId = 1719158400 </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- C√≥digo de Resultado -->
                <xs:element name="dCodRes" type="tipoCodigoResultado">
                    <xs:annotation>
                        <xs:documentation> C√≥digo oficial del resultado del procesamiento
                            INTERPRETACI√ìN POR CATEGOR√çA: üü¢ C√ìDIGOS DE √âXITO: - 0260: Documento
                            aprobado sin observaciones - 1005: Documento aprobado con observaciones
                            üî¥ C√ìDIGOS DE ERROR DE VALIDACI√ìN (04xx): - 0401: Error en estructura
                            XML del documento - 0402: Faltan datos obligatorios - 0403: Errores en
                            c√°lculos matem√°ticos - 0404: Datos fuera de rangos v√°lidos - 0405:
                            Inconsistencias entre campos üî¥ C√ìDIGOS DE ERROR DE FIRMA (05xx): -
                            0501: Firma digital inv√°lida - 0502: Certificado vencido o inv√°lido -
                            0503: Certificado no emitido por PSC autorizado - 0504: Error en cadena
                            de certificaci√≥n ‚ö†Ô∏è C√ìDIGOS DE ERROR T√âCNICO (99xx): - 9901: Error
                            interno del servidor SIFEN - 9902: Servicio temporalmente no disponible
                            - 9903: Timeout en procesamiento ACCI√ìN POR C√ìDIGO: - 0260/1005:
                            Continuar con proceso normal - 04xx: Corregir documento y reenviar -
                            05xx: Verificar certificado y firma - 99xx: Reintentar despu√©s de un
                            tiempo </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Mensaje de Resultado -->
                <xs:element name="dMsgRes" type="tipoMensajeResultado">
                    <xs:annotation>
                        <xs:documentation> Mensaje descriptivo del resultado del procesamiento
                            EJEMPLOS REALES: ‚úÖ √âXITO: - "Documento electr√≥nico recibido
                            satisfactoriamente" - "DE procesado y registrado correctamente" üü° √âXITO
                            CON OBSERVACIONES: - "Documento aprobado. Observaci√≥n: fecha de emisi√≥n
                            superior a la fecha actual" - "DE registrado con advertencias menores en
                            campos opcionales" ‚ùå ERRORES DE VALIDACI√ìN: - "Error en el campo E605
                            dPUniProSer: valor fuera del rango permitido" - "CDC duplicado: ya
                            existe un documento con este c√≥digo de control" - "Total general no
                            coincide con la sumatoria de items" ‚ùå ERRORES DE FIRMA: - "Firma digital
                            inv√°lida: certificado vencido el 2025-05-15" - "Certificado no emitido
                            por PSC autorizado en Paraguay" ‚ö†Ô∏è ERRORES T√âCNICOS: - "Error interno
                            del servidor. Reintente en unos minutos" - "Servicio de validaci√≥n
                            temporalmente no disponible" CARACTER√çSTICAS: - Texto en espa√±ol -
                            Informaci√≥n espec√≠fica y accionable - Referencias a campos espec√≠ficos
                            cuando aplique - Orientaci√≥n clara para resoluci√≥n </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Fecha y Hora de Procesamiento -->
                <xs:element name="dFecProc" type="tipoFechaProcesamiento">
                    <xs:annotation>
                        <xs:documentation> Fecha y hora exacta del procesamiento por SIFEN
                            IMPORTANCIA: - Timestamp oficial para auditor√≠a - Referencia temporal
                            para validez - Base para c√°lculo de plazos legales - Ordenamiento
                            cronol√≥gico de operaciones TIMEZONE: - Hora local de Paraguay (GMT-3) -
                            Sin ajustes por horario de verano FORMATO: YYYY-MM-DDTHH:mm:ss EJEMPLO:
                            2025-06-23T14:30:45 USO: - Logs de auditor√≠a - Reportes temporales -
                            Sincronizaci√≥n de sistemas - C√°lculo de vencimientos </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- N√∫mero de Transacci√≥n/Protocolo (opcional) -->
                <xs:element name="dProtAut" type="tipoNumeroTransaccion" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> N√∫mero de transacci√≥n o protocolo de autorizaci√≥n
                            PRESENCIA: ‚úÖ Presente cuando: dCodRes = 0260 o 1005 (aprobado) ‚ùå Ausente
                            cuando: dCodRes = 04xx, 05xx, 99xx (rechazado/error) CARACTER√çSTICAS: -
                            √önico por documento aprobado - Generado autom√°ticamente por SIFEN -
                            Inmutable una vez asignado - Referencia para operaciones futuras USOS
                            POSTERIORES: 1. Consulta de estado del documento 2. Registro de eventos
                            (cancelaci√≥n, inutilizaci√≥n) 3. Soporte t√©cnico y debugging 4.
                            Integraci√≥n con sistemas contables 5. Auditor√≠as y reportes oficiales
                            EJEMPLO: 12345678901234567890 ALMACENAMIENTO: - Guardar en base de datos
                            local - Asociar con CDC del documento - Incluir en logs de transacciones
                            - Referenciar en documentos relacionados </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- Informaci√≥n Adicional (opcional) -->
                <xs:element name="dInfoAdicional" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> Informaci√≥n adicional sobre el procesamiento CONTENIDO
                            T√çPICO: - Detalles espec√≠ficos de observaciones - Referencias a
                            normativas aplicadas - Informaci√≥n de debugging para desarrolladores -
                            Enlaces a documentaci√≥n relevante EJEMPLOS: - "Verificar campo E605:
                            precio unitario con m√°s de 8 decimales" - "Referencia: Nota T√©cnica
                            NT_E_KUATIA_012_MT_V150" - "Consultar manual t√©cnico secci√≥n 4.2.3"
                            FORMATO: - Texto libre - M√°ximo 1000 caracteres - Informaci√≥n
                            complementaria no cr√≠tica </xs:documentation>
                    </xs:annotation>
                    <xs:simpleType>
                        <xs:restriction base="xs:string">
                            <xs:minLength value="1" />
                            <xs:maxLength value="1000" />
                            <xs:whiteSpace value="preserve" />
                        </xs:restriction>
                    </xs:simpleType>
                </xs:element>

            </xs:sequence>

            <!-- Atributos del elemento respuesta -->
            <xs:attribute name="version" type="xs:string" fixed="1.5.0">
                <xs:annotation>
                    <xs:documentation> Versi√≥n del schema de respuesta SIFEN utilizado VALOR FIJO:
                        "1.5.0" PROPOSITO: Identificar versi√≥n para compatibilidad </xs:documentation>
                </xs:annotation>
            </xs:attribute>

        </xs:complexType>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- TIPOS AUXILIARES PARA PROCESAMIENTO                                  -->
    <!-- ===================================================================== -->

    <!-- Tipo para an√°lisis program√°tico de respuesta -->
    <xs:complexType name="tipoAnalisisRespuesta">
        <xs:annotation>
            <xs:documentation> Tipo auxiliar para an√°lisis program√°tico de respuestas USOS: -
                Parsing automatizado de respuestas - Clasificaci√≥n de resultados - Testing
                automatizado - Generaci√≥n de reportes </xs:documentation>
        </xs:annotation>
        <xs:sequence>
            <xs:element name="exitoso" type="xs:boolean">
                <xs:annotation>
                    <xs:documentation> Indica si el procesamiento fue exitoso true: dCodRes = 0260 o
                        1005 false: dCodRes = 04xx, 05xx, 99xx </xs:documentation>
                </xs:annotation>
            </xs:element>
            <xs:element name="categoria" type="xs:string">
                <xs:annotation>
                    <xs:documentation> Categor√≠a del resultado: EXITO, ERROR_VALIDACION,
                        ERROR_FIRMA, ERROR_TECNICO </xs:documentation>
                </xs:annotation>
            </xs:element>
        </xs:sequence>
    </xs:complexType>

    <!-- ===================================================================== -->
    <!-- VALIDACIONES Y RESTRICCIONES                                         -->
    <!-- ===================================================================== -->

    <!-- Elemento para validaci√≥n de respuesta completa -->
    <xs:element name="validacionRespuesta">
        <xs:annotation>
            <xs:documentation> Elemento auxiliar para validaci√≥n de respuestas SIFEN PROP√ìSITO: -
                Testing automatizado de respuestas - Validaci√≥n de estructura - Verificaci√≥n de
                consistencia VALIDACIONES IMPLEMENTADAS: - Estructura XML v√°lida - C√≥digos de
                resultado reconocidos - Fechas en formato correcto - Correlaci√≥n ID request-response
                COMPATIBILIDAD: XSD 1.0 (oficial SET Paraguay) </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <xs:element ref="resRecepDE" />
            </xs:sequence>
        </xs:complexType>
    </xs:element>

    <!--  ==== Estructura Principal ====
        <resRecepDE version="1.5.0">
            <dId>1719158400</dId>                     Correlaci√≥n con request
            <dCodRes>0260</dCodRes>                   C√≥digo resultado
            <dMsgRes>Documento recibido...</dMsgRes>   Mensaje descriptivo
            <dFecProc>2025-06-23T14:30:45</dFecProc>  Timestamp procesamiento
            <dProtAut>12345678901234567890</dProtAut>  N√∫mero autorizaci√≥n (si aprobado)
            <dInfoAdicional>...</dInfoAdicional>       Info adicional (opcional)
        </resRecepDE>

        ==== Implementaci√≥n en C√≥digo Python ====
        
        def procesar_respuesta_sifen(response_xml: str) -> dict:
            """Procesa respuesta de SIFEN y retorna resultado estructurado"""
            root = ET.fromstring(response_xml)
            
            codigo = root.find('dCodRes').text
            mensaje = root.find('dMsgRes').text
            fecha_proc = root.find('dFecProc').text
            protocolo = root.find('dProtAut')
            
            return {
                'exitoso': codigo in ['0260', '1005'],
                'aprobado': codigo == '0260',
                'aprobado_con_observaciones': codigo == '1005',
                'codigo': codigo,
                'mensaje': mensaje,
                'fecha_procesamiento': fecha_proc,
                'numero_autorizacion': protocolo.text if protocolo is not None else None,
                'categoria': clasificar_codigo(codigo)
            }

        def clasificar_codigo(codigo: str) -> str:
            """Clasifica el c√≥digo de respuesta en categor√≠as"""
            if codigo in ['0260', '1005']:
                return 'EXITO'
            elif codigo.startswith('04'):
                return 'ERROR_VALIDACION'
            elif codigo.startswith('05'):
                return 'ERROR_FIRMA'
            elif codigo.startswith('99'):
                return 'ERROR_TECNICO'
            else:
                return 'DESCONOCIDO'
     -->
</xs:schema>