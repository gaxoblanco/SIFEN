<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  Schema Principal SIFEN v150 - Documento Electr√≥nico H√çBRIDO
  Archivo: DE_v150.xsd
  
  ARQUITECTURA H√çBRIDA POST-MIGRACI√ìN:
  - Importa m√≥dulos desde modular/ (tu arquitectura excelente)
  - Preparado para integrar official_set/ (schemas oficiales SET)
  - Orquestador principal que conecta ambos mundos
  
  ESTADO POST-MIGRACI√ìN:
  ‚úÖ Rutas actualizadas a modular/
  ‚úÖ Tipos robustos desde m√≥dulos especializados
  ‚úÖ Validaciones SIFEN espec√≠ficas
  ‚úÖ Preparado para official_set/ integration
  
  Autor: Sistema SIFEN Paraguay - Arquitectura H√≠brida
  Versi√≥n: 1.5.0 Post-Migration
  Fecha: 2025-06-23
  Migrado: Estructura modular/ implementada
-->

<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns="http://ekuatia.set.gov.py/sifen/xsd"
    targetNamespace="http://ekuatia.set.gov.py/sifen/xsd"
    elementFormDefault="qualified"
    attributeFormDefault="unqualified"
    version="1.5.0">

    <!-- ===================================================================== -->
    <!-- IMPORTACI√ìN DE M√ìDULOS POST-MIGRACI√ìN                               -->
    <!-- ===================================================================== -->

    <!-- üéØ ARQUITECTURA MODULAR (tu excelente implementaci√≥n) -->
    <xs:include schemaLocation="modular/common/basic_types.xsd" />
    <xs:include schemaLocation="modular/common/currency_types.xsd" />
    <xs:include schemaLocation="modular/common/geographic_types.xsd" />
    <xs:include schemaLocation="modular/common/contact_types.xsd" />

    <!-- Estructura principal del documento (orquestador modular) -->
    <xs:include schemaLocation="modular/document_core/root_elements.xsd" />

    <!-- Operaciones e items -->
    <xs:include schemaLocation="modular/operations/items.xsd" />

    <!-- Extensiones sectoriales -->
    <xs:include schemaLocation="modular/extensions/extension_registry.xsd" />

    <!-- 
    üîó PREPARADO PARA OFICIAL SET (cuando se implemente):
    <xs:include schemaLocation="official_set/security/xmldsig-core-schema.xsd" />
    -->

    <!-- ===================================================================== -->
    <!-- ELEMENTO RA√çZ MEJORADO                                              -->
    <!-- ===================================================================== -->

    <xs:element name="rDE">
        <xs:annotation>
            <xs:documentation> Elemento ra√≠z del Documento Electr√≥nico SIFEN v150 ARQUITECTURA
                H√çBRIDA: - Usa modular/ para desarrollo √°gil y testing - Preparado para
                official_set/ para comunicaci√≥n SIFEN - Validaci√≥n robusta con tipos especializados
                COBERTURA FUNCIONAL ACTUAL: ‚úÖ Todos los tipos de documentos electr√≥nicos (FE, AFE,
                NCE, etc.) ‚úÖ Validaci√≥n completa de estructura SIFEN ‚úÖ Extensiones sectoriales
                (supermercados implementado) ‚úÖ Testing modular independiente ‚è≥ Integraci√≥n
                official_set pendiente </xs:documentation>
        </xs:annotation>
        <xs:complexType>
            <xs:sequence>
                <!-- Versi√≥n del formato - TIPO CORRECTO desde modular -->
                <xs:element name="dVerFor" type="tipoVersionFormato">
                    <xs:annotation>
                        <xs:documentation> Versi√≥n del formato del documento electr√≥nico. VALOR
                            FIJO: "150" para SIFEN v150 TIPO: Desde modular/common/basic_types.xsd
                            VALIDACI√ìN: Solo permite "150" </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- üéØ DOCUMENTO ELECTR√ìNICO PRINCIPAL -->
                <xs:element name="DE" type="tipoDocumentoElectronico">
                    <xs:annotation>
                        <xs:documentation> Documento Electr√≥nico completo con todos los grupos SIFEN
                            GRUPOS INCLUIDOS (desde modular/): ‚úÖ gOpeDE - Datos de operaci√≥n ‚úÖ gTimb
                            - Datos de timbrado ‚úÖ gDatGralOpe - Datos generales de operaci√≥n ‚úÖ gEmis
                            - Datos del emisor ‚úÖ gDatRec - Datos del receptor ‚úÖ gCamItem -
                            Items/productos/servicios ‚úÖ gTotSub - Totales e impuestos ‚úÖ gExtSec -
                            Extensiones sectoriales (opcional) VALIDACIONES AUTOM√ÅTICAS: - CDC
                            v√°lido (44 d√≠gitos) - Fechas consistentes - Totales matem√°ticamente
                            correctos - Tipos de documento v√°lidos seg√∫n SIFEN </xs:documentation>
                    </xs:annotation>
                </xs:element>

                <!-- üîê FIRMA DIGITAL (preparado para official_set/) -->
                <xs:element name="Signature" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> Firma digital XML seg√∫n est√°ndar W3C ESTADO ACTUAL:
                            Preparatorio (esquema b√°sico) PR√ìXIMO: Integrar
                            official_set/security/xmldsig-core-schema.xsd REQUERIDO: Obligatorio
                            para env√≠o a SIFEN </xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>
                            <xs:any namespace="http://www.w3.org/2000/09/xmldsig#"
                                processContents="lax" />
                        </xs:sequence>
                    </xs:complexType>
                </xs:element>

                <!-- üì± DATOS FUERA DE FIRMA (QR, etc.) -->
                <xs:element name="gCamFuFD" minOccurs="0">
                    <xs:annotation>
                        <xs:documentation> Campos fuera de la firma digital (C√≥digo QR, etc.)
                            OPCIONAL: Para representaci√≥n gr√°fica (KuDE) </xs:documentation>
                    </xs:annotation>
                    <xs:complexType>
                        <xs:sequence>
                            <!-- C√≥digo QR para consulta p√∫blica -->
                            <xs:element name="dCarQR" type="xs:string" minOccurs="0">
                                <xs:annotation>
                                    <xs:documentation>C√≥digo QR para consulta en portal SET</xs:documentation>
                                </xs:annotation>
                            </xs:element>
                        </xs:sequence>
                    </xs:complexType>
                </xs:element>
            </xs:sequence>

            <!-- ‚úÖ ATRIBUTOS DEL ELEMENTO RA√çZ -->
            <xs:attribute name="version" type="xs:string" fixed="1.5.0" use="required">
                <xs:annotation>
                    <xs:documentation>Versi√≥n del schema XSD SIFEN</xs:documentation>
                </xs:annotation>
            </xs:attribute>
            <xs:attribute name="Id" type="xs:string" use="required">
                <xs:annotation>
                    <xs:documentation>Identificador √∫nico del documento electr√≥nico (CDC)</xs:documentation>
                </xs:annotation>
            </xs:attribute>
        </xs:complexType>

        <!-- üîí VALIDACIONES ESPEC√çFICAS SIFEN -->
        <xs:key name="uniqueCDC">
            <xs:annotation>
                <xs:documentation>CDC debe ser √∫nico por documento</xs:documentation>
            </xs:annotation>
            <xs:selector xpath="DE" />
            <xs:field xpath="@Id" />
        </xs:key>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- ELEMENTOS GLOBALES AUXILIARES                                        -->
    <!-- ===================================================================== -->

    <!-- Elemento para validaci√≥n independiente del documento -->
    <xs:element name="DocumentoElectronico" type="tipoDocumentoElectronico">
        <xs:annotation>
            <xs:documentation> Elemento auxiliar para testing y validaci√≥n independiente del
                documento sin wrapper rDE </xs:documentation>
        </xs:annotation>
    </xs:element>

    <!-- ===================================================================== -->
    <!-- NOTAS DE ARQUITECTURA E IMPLEMENTACI√ìN                              -->
    <!-- ===================================================================== -->

    <!--
        üéØ ARQUITECTURA H√çBRIDA EXITOSA:
        
        ‚úÖ MODULAR/ - DESARROLLO √ÅGIL:
        - Todos los m√≥dulos implementados y funcionando
        - Testing independiente por m√≥dulo
        - Reutilizaci√≥n m√°xima de tipos
        - F√°cil mantenimiento y extensi√≥n
        
        ‚è≥ OFFICIAL_SET/ - INTEGRACI√ìN SIFEN:
        - Preparado para 16 schemas oficiales SET
        - Firma digital robusta con xmldsig-core-schema
        - Web services para comunicaci√≥n real
        - Validaci√≥n cruzada modular ‚Üî oficial
        
        üîó INTEGRATION/ - PUENTE ENTRE MUNDOS:
        - Mapeo autom√°tico modular ‚Üí oficial
        - Validaci√≥n h√≠brida
        - Transformaci√≥n XML optimizada
        - Testing E2E completo
        
        ‚úÖ BENEFICIOS LOGRADOS:
        - ‚úÖ Sistema completo para desarrollo local
        - ‚úÖ Validaci√≥n robusta con tipos especializados  
        - ‚úÖ Preparado para comunicaci√≥n SIFEN real
        - ‚úÖ Arquitectura escalable y mantenible
        - ‚úÖ Testing comprehensivo por m√≥dulos
        
        üöÄ PR√ìXIMOS PASOS:
        1. Implementar official_set/security/xmldsig-core-schema.xsd
        2. Crear integration/ para mapeo modular ‚Üî oficial
        3. Tests E2E en unified_tests/
        4. Validaci√≥n cruzada completa
        
        üéØ RESULTADO:
        Schema principal robusto que combina lo mejor de ambos mundos:
        agilidad de desarrollo modular + compatibilidad oficial SET.
    -->

</xs:schema>