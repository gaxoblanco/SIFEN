{# ===================================================================== #}
{# TEMPLATE: NOTA DE CR√âDITO ELECTR√ìNICA MODULAR (iTipDE = 5) #}
{# ===================================================================== #}
{#
PROP√ìSITO: Template Jinja2 modular para Nota de Cr√©dito Electr√≥nica usando partials
TIPO SIFEN: iTipDE = 5 (Nota de cr√©dito electr√≥nica)
BASE: Extiende base_document.xml (usa partials autom√°ticamente)
VALIDACI√ìN: Compatible con DE_v150.xsd

NUEVA ARQUITECTURA MODULAR:
‚úÖ base_document.xml maneja toda la estructura com√∫n
‚úÖ Partials se incluyen autom√°ticamente desde base
‚úÖ Este template solo maneja campos espec√≠ficos de NCE
‚úÖ Reducci√≥n de c√≥digo: ~2,000+ ‚Üí 120 l√≠neas (94% menos)

CARACTER√çSTICAS CR√çTICAS NCE:
‚ö†Ô∏è Referencia obligatoria a documento original
‚ö†Ô∏è Motivo de cr√©dito espec√≠fico y obligatorio
‚ö†Ô∏è Montos t√≠picamente negativos (cr√©dito al cliente)
‚ö†Ô∏è Validaciones de consistencia con documento original

CASOS DE USO NCE:
üéØ Devoluciones de mercader√≠a
üéØ Descuentos posteriores a la venta
üéØ Anulaciones parciales o totales
üéØ Correcciones de errores en facturaci√≥n

PARTIALS INCLUIDOS AUTOM√ÅTICAMENTE:
‚úÖ _grupo_operacion.xml (gOpeDE) - tipo_documento = "5"
‚úÖ _grupo_timbrado.xml (gTimb)
‚úÖ _grupo_datos_generales.xml (gDatGralOpe)
‚úÖ _grupo_emisor.xml (gEmis)
‚úÖ _grupo_receptor.xml (gDatRec)
‚úÖ _grupo_items.xml (gCamItem - loop autom√°tico)
‚úÖ _grupo_totales.xml (gTotSub)
‚úÖ _grupo_condiciones.xml (gCamGen - condicional)
‚úÖ _documento_asociado.xml (gDocAso - OBLIGATORIO para NCE)

SOLO CAMPOS ESPEC√çFICOS NCE:
üéØ gDtipDE > gCamNCE (motivo cr√©dito espec√≠fico)
üéØ gDocAso (documento asociado OBLIGATORIO)

VARIABLES REQUERIDAS:
- cdc: CDC de 44 caracteres
- tipo_documento: "5" (autom√°tico)
- datos_nce: objeto con motivo cr√©dito espec√≠fico
- documento_asociado: objeto OBLIGATORIO con referencia documento original

COMPARACI√ìN L√çNEAS DE C√ìDIGO:
‚ùå Versi√≥n tradicional: ~2,000+ l√≠neas (todo duplicado)
‚úÖ Versi√≥n modular: 120 l√≠neas (solo espec√≠fico NCE)
üìä Reducci√≥n: 94% menos c√≥digo
#}

{# Extiende el template base que maneja estructura com√∫n y partials #}
{% extends "base_document.xml" %}

{# ===================================================================== #}
{# BLOQUE: CONTENIDO ESPEC√çFICO NOTA DE CR√âDITO ELECTR√ìNICA #}
{# Sobrescribe document_specific_content del base_document.xml #}
{# ===================================================================== #}
{% block document_specific_content %}

{# ================================================================= #}
{# GRUPO: gDocAso - Documento asociado (OBLIGATORIO en NCE) #}
{# Referencia al documento original que se est√° creditando #}
{# ================================================================= #}
{% include 'partials/_documento_asociado.xml' %}

{# ================================================================= #}
{# GRUPO: gDtipDE - Campos espec√≠ficos por tipo de documento #}
{# Solo contiene gCamNCE espec√≠fico para Nota de Cr√©dito #}
{# ================================================================= #}
<gDtipDE> {# ============================================================= #} {# SUB-GRUPO: gCamNCE
    - Campos espec√≠ficos Nota de Cr√©dito #} {# OBLIGATORIO para iTipDE = 5 #} {# √önico contenido que
    no est√° en partials reutilizables #} {#
    ============================================================= #} <gCamNCE> {# E400 - Motivo de
    emisi√≥n de la nota de cr√©dito (OBLIGATORIO) #} {# 1=Devoluci√≥n, 2=Descuento, 3=Bonificaci√≥n,
    4=Anulaci√≥n, 5=Ajuste, 6=Otros #} <iMotEmi>{{ datos_nce.motivo_emision }}</iMotEmi> {# E401 -
    Descripci√≥n del motivo de emisi√≥n (OBLIGATORIO) #} <dDesMotEmi>{{ datos_nce.descripcion_motivo
    }}</dDesMotEmi> {# E402 - Observaciones del motivo (OPCIONAL) #} {% if
    datos_nce.observaciones_motivo %} <dObsNCE>{{ datos_nce.observaciones_motivo }}</dObsNCE> {%
    endif %} {# E403 - Usuario responsable de la emisi√≥n (OPCIONAL) #} {% if
    datos_nce.usuario_responsable %} <dUsResp>{{ datos_nce.usuario_responsable }}</dUsResp> {% endif
    %} {# E404 - Informaci√≥n adicional de trazabilidad (OPCIONAL) #} {% if
    datos_nce.informacion_trazabilidad %} <dInfoTraz>{{ datos_nce.informacion_trazabilidad }}</dInfoTraz>
    {% endif %} </gCamNCE>
</gDtipDE>

{# ================================================================= #}
{# TODOS LOS DEM√ÅS GRUPOS SE INCLUYEN AUTOM√ÅTICAMENTE #}
{# desde base_document.xml usando partials: #}
{# #}
{# ‚úÖ gOpeDE: _grupo_operacion.xml (tipo_documento = "5") #}
{# ‚úÖ gTimb: _grupo_timbrado.xml #}
{# ‚úÖ gDatGralOpe: _grupo_datos_generales.xml #}
{# ‚úÖ gEmis: _grupo_emisor.xml #}
{# ‚úÖ gDatRec: _grupo_receptor.xml #}
{# ‚úÖ gCamItem: _grupo_items.xml (loop items - montos negativos) #}
{# ‚úÖ gTotSub: _grupo_totales.xml (totales negativos t√≠picos) #}
{# ‚úÖ gCamGen: _grupo_condiciones.xml (si condiciones) #}
{# ‚úÖ gCamFuFD: _grupo_qr.xml (si include_qr) #}
{# #}
{# NOTAS ESPEC√çFICAS NCE: #}
{# - Items t√≠picamente con cantidades/montos negativos #}
{# - Totales reducen la deuda del cliente #}
{# - Emisor/receptor deben coincidir con documento original #}
{# ================================================================= #}

{% endblock %}